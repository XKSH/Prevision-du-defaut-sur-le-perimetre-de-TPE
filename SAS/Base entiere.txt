%let SRV=10.100.100.154 10801;  
options comamid=tcp remote=SRV ;
filename rlink "O:\DRG\DRG-9.3.0-Validation-commun\pplsas02_9.4.txt" ;
signon;

rsubmit ;
%LET user = KXU;
%LET pwd = nouveau;
endrsubmit ;


rsubmit;  
	libname Travail "/Equipe_SAS/DRG/VALIDATION/KXU/Travail";
endrsubmit;
libname Travail SLIBREF=Travail SERVER=srv;
libname Swork SLIBREF=Work SERVER=srv;
/*v3ssEILp*/

proc contents data=Travail.Corp_mod_avbilan_sc_sscavsc1 out=contents noprint;
run;

rsubmit;
proc sql;
create table Travail.OBT 
as select * 
from Travail.Corp_mod_avbilan_sc_sscavsc1
where NB_CPTE_ORDINAIRE_SIREN > 0 and motif is null
;
quit;
endrsubmit;

rsubmit;
data Travail.Base_corp_pro_varexp;
set  Travail.Base_corp_pro_varexp_201212 (in=a)
     Travail.Base_corp_pro_varexp_201312 (in=b)
     Travail.Base_corp_pro_varexp_201406 (in=c);

    if a then COHORTE=201212;
    if b then COHORTE=201312;
    if c then COHORTE=201412;
run;
endrsubmit;

rsubmit;
proc sql;
create table Travail.Base_tempo 
as select *
from Travail.OBT 
where COHORTE=201212  or COHORTE=201312;
quit;
endrsubmit;

rsubmit;
proc sql;
create table Travail.Base_tempo1 
as select *
from Travail.OBT 
where COHORTE=201412;
quit;
endrsubmit;


rsubmit ;
proc sql ;
create table Travail.Temps as select a.* , b.*
    from  Travail.Base_tempo  as a
    LEFT JOIN Travail.Base_corp_pro_varexp as b 
    on a.siren = b.siren  and a.cohorte = b.cohorte
; 
quit ;
endrsubmit ;

rsubmit;
proc sql ;
create table Travail.Horstemps as select a.* , b.*
    from  Travail.Base_tempo1  as a
    LEFT JOIN Travail.Base_corp_pro_varexp as b 
    on a.siren = b.siren  and a.cohorte = b.cohorte
; 
quit ;
endrsubmit ;

rsubmit ;
proc sql;
create table Travail.Tempsuniq as
select *
from Travail.Temps
group by siren
having cohorte = max(cohorte);
quit;
endrsubmit ;

rsubmit ;
proc sql;
create table Travail.Horstempsuniq as
select *
from Travail.Horstemps
order by siren;
quit;
endrsubmit ;

rsubmit ;
data Travail.Tempsuniq_final;
set Travail.Tempsuniq (keep=
SIREN
CATJUR_REF
COHORTE
COSEG_REF
NOTE_MOTEUR_T
top_actif
CA_FINAL
TOP_LBO_REF_AC
COD_ACT_REF
ENGT_TIERS
ENGT_SIREN
COD_ALLUR_CAV_CLI
PERIMETRE
TOP_FILLE_CONSO
TOP_INCID_SIREN
top_dft_auto_pro_corp
NB_TIERS_SIREN
MT_MVT_DEBT_SIREN_12M
MT_MVT_CRDT_SIREN_12M
NB_JOUR_CRDT_SIREN_12M
NB_JOUR_DEBT_SIREN_12M
SLDE_MOY_SIREN_1M
SLDE_MOY_SIREN_3M
MT_AUTO_SIREN
MNT_AUTO_DAILLY_SIREN
MNT_AUTO_ESCOMPTE_SIREN
MNT_AUTO_CC_SIREN
MNT_STK_EPARGF_SIREN
MNT_STK_EPARGM_SIREN
MNT_STK_EPARG_TOT_SIREN
NB_PRETAM_SIREN
NB_PRETNAM_SIREN
NB_PRET_ESCOMPTE_DAILLY_SIREN
NB_PRET_DAILLY_SIREN
NB_PRET_ESCOMPTE_SIREN
NB_CREANCES_COMM_SIREN
NB_CRDT_TRESO_SIREN
NB_PRET_REST_SIREN
NB_EP_FINN_SIREN
NB_EP_MONT_SIREN
NB_EP_TOT_SIREN
NB_CRDT_EQUIP_SIREN
NB_PRET_SIREN
NB_PRET_HABITAT_SIREN
NB_REVOLVING_SIREN
NB_CPTE_A_TERME_SIREN
NB_PRET_PERSO_SIREN
NB_AUTRES_CRDT_SIREN
NB_ENG_FIN_SIREN
NB_ENG_GAR_SIREN
MT_CRNC_PRETAM_SIREN
MT_CRNC_PRET_SIREN
MT_ENGG_PRET_SIREN
MT_ENGG_HBILN_PRET_SIREN
MT_ENGG_BILN_PRET_SIREN
MT_ENGG_PRETAM_SIREN
MT_ENGG_BILN_PRETAM_SIREN
MT_ENGG_HBILN_PRETAM_SIREN
MT_IMPS_PRETAM_SIREN
MT_IMPS_PRET_SIREN
EFFECTIF_ENTREPRISE
MNT_EE_CLI_12M_SIREN
NB_EE_CLI_12M_SIREN
ANC_ENTREPRISE
NB_MOIS_REL_SIREN
COT_BDF_ENTREP
RL1
RL2
RL3
RL4
RL5
RL6
RL7
RL8
RL9
RL10
RSS1
RSS2
RSS3
RSS4
RSS5
RSS6
RSS8
RSS9
RSS10
RSS11
RSS12
RSS13
RSS14
RR1
RR2
RR3
RR4
RR5
RR6
RR7
RR8
RR9
RR10
RR11
RR12
RR13
RRF1
RRF2
RRF3
RRF4
RL1_NUMR
RL1_DENR
RL2_NUMR
RL2_DENR
RL3_NUMR
RL3_DENR
RL4_NUMR
RL4_DENR
RL5_NUMR
RL5_DENR
RL6_NUMR
RL6_DENR
RL7_NUMR
RL7_DENR
RL8_NUMR
RL8_DENR
RL9_NUMR
RL9_DENR
RL10_NUMR
RL10_DENR
RSS1_NUMR
RSS1_DENR
RSS2_NUMR
RSS2_DENR
RSS3_NUMR
RSS3_DENR
RSS4_NUMR
RSS4_DENR
RSS5_NUMR
RSS5_DENR
RSS6_NUMR
RSS6_DENR
ENDETT_FIN
RSS8_DENR
RSS9_NUMR
RSS9_DENR
RSS10_NUMR
RSS10_DENR
RSS11_NUMR
RSS11_DENR
RSS12_NUMR
RSS12_DENR
RSS13_NUMR
RSS13_DENR
RSS14_NUMR
RSS14_DENR
RR1_NUMR
RR1_DENR
RR2_NUMR
RR2_DENR
RR3_NUMR
RR3_DENR
RR4_NUMR
RR4_DENR
RR5_NUMR
RR5_DENR
RR6_NUMR
RR6_DENR
RR7_NUMR
RR7_DENR
RR8_NUMR
RR8_DENR
RR9_NUMR
RR9_DENR
RR10_NUMR
RR10_DENR
RR11_NUMR
RR11_DENR
RR12_NUMR
RR12_DENR
RR13_NUMR
RR13_DENR
RRF1_NUMR
RRF1_DENR
RRF2_NUMR
RRF2_DENR
RRF3_NUMR
RRF3_DENR
RRF4_NUMR
RRF4_DENR
ENGT_CT_SIREN_VAR12
ENGT_CT_BDF_SIREN_VAR12
NB_CPTE_ORDINAIRE_SIREN
TOP_CLNT_ACTIF_CLI_DITG_2
TOP_INCD_12M_SIREN
RATIO_SOLDE_ENGT
NBJ_DEPASS_MOIS_SIREN_12M
class_PD_N3
class_PD_COFACE
CATJUR_REF
COSEG_REF
top_actif
TOP_LBO_REF_AC
COD_ACT_REF
COD_ALLUR_CAV_CLI
PERIMETRE
TOP_FILLE_CONSO
TOP_INCID_SIREN
COT_BDF_ENTREP
TOP_CLNT_ACTIF_CLI_DITG_2
TOP_INCD_12M_SIREN
);
run;
endrsubmit ;

rsubmit ;
data Travail.Horstempsuniq_final;
set Travail.Horstempsuniq (keep=
SIREN
CATJUR_REF
COHORTE
COSEG_REF
NOTE_MOTEUR_T
top_actif
CA_FINAL
TOP_LBO_REF_AC
COD_ACT_REF
ENGT_TIERS
ENGT_SIREN
COD_ALLUR_CAV_CLI
PERIMETRE
TOP_FILLE_CONSO
TOP_INCID_SIREN
top_dft_auto_pro_corp
NB_TIERS_SIREN
MT_MVT_DEBT_SIREN_12M
MT_MVT_CRDT_SIREN_12M
NB_JOUR_CRDT_SIREN_12M
NB_JOUR_DEBT_SIREN_12M
SLDE_MOY_SIREN_1M
SLDE_MOY_SIREN_3M
MT_AUTO_SIREN
MNT_AUTO_DAILLY_SIREN
MNT_AUTO_ESCOMPTE_SIREN
MNT_AUTO_CC_SIREN
MNT_STK_EPARGF_SIREN
MNT_STK_EPARGM_SIREN
MNT_STK_EPARG_TOT_SIREN
NB_PRETAM_SIREN
NB_PRETNAM_SIREN
NB_PRET_ESCOMPTE_DAILLY_SIREN
NB_PRET_DAILLY_SIREN
NB_PRET_ESCOMPTE_SIREN
NB_CREANCES_COMM_SIREN
NB_CRDT_TRESO_SIREN
NB_PRET_REST_SIREN
NB_EP_FINN_SIREN
NB_EP_MONT_SIREN
NB_EP_TOT_SIREN
NB_CRDT_EQUIP_SIREN
NB_PRET_SIREN
NB_PRET_HABITAT_SIREN
NB_REVOLVING_SIREN
NB_CPTE_A_TERME_SIREN
NB_PRET_PERSO_SIREN
NB_AUTRES_CRDT_SIREN
NB_ENG_FIN_SIREN
NB_ENG_GAR_SIREN
MT_CRNC_PRETAM_SIREN
MT_CRNC_PRET_SIREN
MT_ENGG_PRET_SIREN
MT_ENGG_HBILN_PRET_SIREN
MT_ENGG_BILN_PRET_SIREN
MT_ENGG_PRETAM_SIREN
MT_ENGG_BILN_PRETAM_SIREN
MT_ENGG_HBILN_PRETAM_SIREN
MT_IMPS_PRETAM_SIREN
MT_IMPS_PRET_SIREN
EFFECTIF_ENTREPRISE
MNT_EE_CLI_12M_SIREN
NB_EE_CLI_12M_SIREN
ANC_ENTREPRISE
NB_MOIS_REL_SIREN
COT_BDF_ENTREP
RL1
RL2
RL3
RL4
RL5
RL6
RL7
RL8
RL9
RL10
RSS1
RSS2
RSS3
RSS4
RSS5
RSS6
RSS8
RSS9
RSS10
RSS11
RSS12
RSS13
RSS14
RR1
RR2
RR3
RR4
RR5
RR6
RR7
RR8
RR9
RR10
RR11
RR12
RR13
RRF1
RRF2
RRF3
RRF4
RL1_NUMR
RL1_DENR
RL2_NUMR
RL2_DENR
RL3_NUMR
RL3_DENR
RL4_NUMR
RL4_DENR
RL5_NUMR
RL5_DENR
RL6_NUMR
RL6_DENR
RL7_NUMR
RL7_DENR
RL8_NUMR
RL8_DENR
RL9_NUMR
RL9_DENR
RL10_NUMR
RL10_DENR
RSS1_NUMR
RSS1_DENR
RSS2_NUMR
RSS2_DENR
RSS3_NUMR
RSS3_DENR
RSS4_NUMR
RSS4_DENR
RSS5_NUMR
RSS5_DENR
RSS6_NUMR
RSS6_DENR
ENDETT_FIN
RSS8_DENR
RSS9_NUMR
RSS9_DENR
RSS10_NUMR
RSS10_DENR
RSS11_NUMR
RSS11_DENR
RSS12_NUMR
RSS12_DENR
RSS13_NUMR
RSS13_DENR
RSS14_NUMR
RSS14_DENR
RR1_NUMR
RR1_DENR
RR2_NUMR
RR2_DENR
RR3_NUMR
RR3_DENR
RR4_NUMR
RR4_DENR
RR5_NUMR
RR5_DENR
RR6_NUMR
RR6_DENR
RR7_NUMR
RR7_DENR
RR8_NUMR
RR8_DENR
RR9_NUMR
RR9_DENR
RR10_NUMR
RR10_DENR
RR11_NUMR
RR11_DENR
RR12_NUMR
RR12_DENR
RR13_NUMR
RR13_DENR
RRF1_NUMR
RRF1_DENR
RRF2_NUMR
RRF2_DENR
RRF3_NUMR
RRF3_DENR
RRF4_NUMR
RRF4_DENR
ENGT_CT_SIREN_VAR12
ENGT_CT_BDF_SIREN_VAR12
NB_CPTE_ORDINAIRE_SIREN
TOP_CLNT_ACTIF_CLI_DITG_2
TOP_INCD_12M_SIREN
RATIO_SOLDE_ENGT
NBJ_DEPASS_MOIS_SIREN_12M
class_PD_N3
class_PD_COFACE
CATJUR_REF
COSEG_REF
top_actif
TOP_LBO_REF_AC
COD_ACT_REF
COD_ALLUR_CAV_CLI
PERIMETRE
TOP_FILLE_CONSO
TOP_INCID_SIREN
COT_BDF_ENTREP
TOP_CLNT_ACTIF_CLI_DITG_2
TOP_INCD_12M_SIREN
);
run;
endrsubmit ;